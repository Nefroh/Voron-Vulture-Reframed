##Top includes
[include mainsail.cfg]
[include tmctune.cfg]
# Octopus Pro 1.1 H723
# https://github.com/bigtreetech/BIGTREETECH-OCTOPUS-Pro

#******                                                     ******#
###******                                                 ******###
#####******                                              *****#####
#######*****                                           ******######
#########*****                                       ******########
##########******                                   ******##########
############******                               ******############
##############******                            *****##############
  ##############******                        *****##############  
    ##############******                    ******#############    
      ##############*****#                ******#############      
        ##############*****             ******##############       
          ##############*****         #*****##############         
            #############******      *****##############           
             ##############******  ******#############             
               ##############**********#############               
                 ##############******#############                 
                   #############****#############                  
                     ###########****###########                    
                       #########****#########                      
 ####    ###*  ###   ***************#                              
 ####  ####*   ###   ##*************                               
 #### ###*     ###          ###         ###         ###            
 ######*       ###   ##   ########   #########   ########   ###### 
 ######*       ###   ##   ###   ###  ###    ###  ##    ###  ###    
 #######**     ###   ##   ###    ##  ###    ### ##########  ###    
 ####  ###**   ###   ##   ###   ###  ###    ##   ###        ###    
 ####    ###*  ###   ##   ########   ########     #######   ###    
                          ###        ###                           
                          ###        ###                           
#fu
#####################################################################
#   Main Config - Vulture
#####################################################################
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_0C0022000251313239393734-if00
restart_method: command

[virtual_sdcard]
path: /home/bigKlipperPi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 3000             
max_z_velocity: 15          
max_z_accel: 350
square_corner_velocity: 5.0

[temperature_sensor octo_mcu_temp]
sensor_type: temperature_mcu
sensor_mcu: mcu

[force_move]
enable_force_move: True

#####################################################################
#   Eddy
#####################################################################
[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_5044506128A8201C-if00
restart_method: command

[probe_eddy_ng btt_eddy]
sensor_type: btt_eddy
i2c_mcu: eddy
i2c_bus: i2c0f
x_offset: 0 
y_offset: 24 #? 

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu
sensor_mcu: eddy
min_temp: 10
max_temp: 100

[temperature_sensor btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26

[bed_mesh]
horizontal_move_z: 2.0 
speed: 150
mesh_min: 20, 25 
mesh_max: 220, 220 
probe_count: 9, 9
algorithm: bicubic
scan_overshoot: 8

[safe_z_home]
home_xy_position: 120, 125
z_hop: 10
z_hop_speed: 15 # was 25
speed: 200

#####################################################################
#   Extruder
#####################################################################
[thermistor my_thermistor_e]
temperature1:25
resistance1:110000
temperature2:100
resistance2:7008
temperature3:220
resistance3:435

#   Connected to MOTOR_4
#   Heater - HE0
#   Thermistor - TB
[extruder]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 6.5 # default 22.6789511  
#gear_ratio: 50:10
microsteps: 16
full_steps_per_rotation: 200    
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PA0
sensor_type:my_thermistor_e
sensor_pin: PF3
min_temp: 10
max_temp: 300
max_power: 1.0
min_extrude_temp: 170
control = pid
pid_kp : 33.838
pid_ki : 5.223
pid_kd : 47.752

##  E0 on MOTOR4
##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 extruder]
uart_pin: PF2
interpolate: true
run_current: 0.8
sense_resistor: 0.110
#stealthchop_threshold: 0

#####################################################################
#  Extruder temp tolerance override
#####################################################################
[gcode_macro M109] # Wait Hotend Temp
rename_existing: M109.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  # Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-5} MAXIMUM={s+5}   # Wait for hotend temp (within n degrees)
    {% endif %}

#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF4
max_power: 0.9
min_temp: 0
max_temp: 110 # apparently up to 130 possible
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182

[verify_heater heater_bed]
max_error: 120 
check_gain_time:40
hysteresis: 5
heating_gain: 1

#####################################################################
#   Fan Control
#####################################################################

[fan]
##  Print Cooling Fan - FAN0
pin: PA8
max_power: 1.0
#kick_start_time: 0.5
##  Depending on your fan, you may need to increase this value
##  if your fan will not start. Can change cycle_time (increase)
##  if your fan is not able to slow down effectively

[heater_fan hotend_fan]
pin: PD12
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan MCU_fan]
pin: PE5
kick_start_time: 1
fan_speed: 0.6
idle_timeout: 1200
heater: extruder, heater_bed
stepper: stepper_x, stepper_y

[controller_fan Pi_fan]
pin: PD13
kick_start_time: 1
fan_speed: 1.0
idle_timeout: 2000
heater: extruder, heater_bed
stepper: stepper_x, stepper_y

#[heater_fan exhaust_fan]
##  Exhaust fan - FAN3
#pin: PD13
#max_power: 1.0
#shutdown_speed: 0.0
#kick_start_time: 5.0
#heater: heater_bed
#heater_temp: 60
#fan_speed: 1.0

#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: tmc2209_stepper_x: virtual_endstop
position_min: 0

position_endstop: 240
position_max: 240

homing_speed: 70  #Max 100
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: true # false if not using tmctune
run_current: 1.2
sense_resistor: 0.110
#stealthchop_threshold: 0
diag_pin: PG6

##  A Stepper - Right
##  Connected to MOTOR_1
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: tmc2209_stepper_y: virtual_endstop
position_min: 0
position_endstop: 250
position_max: 250

homing_speed: 70  #Max 100
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: true # false if not using tmctune
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0
#stealthchop_threshold: 0
diag_pin: PG9

#####################################################################
#   Z Stepper Settings
#####################################################################

##  Z0 Stepper - Front Left
##  Connected to MOTOR_5
[stepper_z]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 4  
microsteps: 32
endstop_pin: probe:z_virtual_endstop
## All builds use same Max Z
position_max: 250
position_min: -2.5
homing_speed: 8.0 # Leadscrews are slower than 2.4, 10 is a recommended max.
second_homing_speed: 3
homing_retract_dist: 3

[tmc2209 stepper_z]
uart_pin: PE4
interpolate: true
run_current: 0.6 # was 0.84
sense_resistor: 0.110
#stealthchop_threshold: 0

##  Z1 Stepper - Rear Center
##  Connected to MOTOR_6
[stepper_z1]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 4 
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PE1
interpolate: true
run_current: 0.6 # was 0.84
sense_resistor: 0.110
#stealthchop_threshold: 0

##  Z2 Stepper - Front Right
##  Connected to MOTOR_7
[stepper_z2]
step_pin: PE6
dir_pin: !PA14
enable_pin: !PE0
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 4 
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PD3
interpolate: true
run_current: 0.6 # was 0.84
sense_resistor: 0.110
#stealthchop_threshold: 0

#                     ......                      
#                     %%%%%%                      
#           ....    ..%%%%%%..    ....            
#         ..%%%%...:%%%%%%%%%%:...%%%%..          
#         %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%          
#         .:%%%%%%%%%%%%%%%%%%%%%%%%%%:.          
#           .%%%%%%%%%%-..-%%%%%%%%%%.            
#          .%%%%%%%% .      . %%%%%%%%.           
#          -%%%%%%..          ..%%%%%%-           
#     .%%%%%%%%%%#              #%%%%%%%%%%.      
#     .%%%%%%%%%%.              .%%%%%%%%%%.      
#     .%%%%%%%%%%*              *%%%%%%%%%%.      
#          -%%%%%%..          ..%%%%%%-           
#          .%%%%%%%% .      . %%%%%%%%.           
#           .%%%%%%%%%%:..:%%%%%%%%%%.            
#         .:%%%%%%%%%%%%%%%%%%%%%%%%%%:.          
#         %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%          
#         ..%%%%...:%%%%%%%%%%:...%%%%..          
#           ..:.    ..%%%%%%..    ....            
#                     %%%%%%                       
#  ____                           _   __  __                          
# / ___| ___ _ __   ___ _ __ __ _| | |  \/  | __ _  ___ _ __ ___  ___ 
#| |  _ / _ \ '_ \ / _ \ '__/ _` | | | |\/| |/ _` |/ __| '__/ _ \/ __|
#| |_| |  __/ | | |  __/ | | (_| | | | |  | | (_| | (__| | | (_) \__ \
# \____|\___|_| |_|\___|_|  \__,_|_| |_|  |_|\__,_|\___|_|  \___/|___/

[z_tilt]
##  Use Z_TILT_ADJUST to level the bed .
##  z_positions: Location of toolhead

z_positions:
    -50, 14 # was -50, 18
    120, 298
    300, 14 # was -50, 18
points:
    30, 30
    120, 190
    210, 30

speed: 200
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - PLEASE CUSTOMISE THE SCRIPT
gcode:
    M117 Homing...                 ; display message
    G28
    Z_TILT_ADJUST
    G28

    G0 X125 Y125 Z30 F3600
   

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-2.0 F3600                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR

    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0


#####################################################################
#------------------------- Filament related-------------------------#
#####################################################################
[gcode_macro LOAD_FILAMENT]
gcode:
    {% set extruder_temp = 250 %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        M117 Extruding...
        G91 
        G1 E75 F500
        G1 E30 F200
        G1 E-2 F300
        G90
        M400
        M117 Filament loaded.
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
        #CLEAN_NOZZLE
    {% else %}
        {action_respond_info("Don't load filament during printing!!!")}
    {% endif %}

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  80
variable_purge_distance:  25
variable_speed: 200
variable_max_velocity: 800
gcode:
    {% set extruder_temp = 250 %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        M117 Retracting...
        G91
        G1 E{purge_distance} F{speed}             # Purge
        G1 E-{unload_distance} F{max_velocity}    # Fast-unload
        G90
        M400
        M117 Filament ejected.
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
        #CLEAN_NOZZLE
    {% else %}
        {action_respond_info("Don't unload filament during printing!!!")}
    {% endif %}

                 
#[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_ng btt_eddy]
#*# calibrated_drive_currents = 16
#*# calibration_version = 5
#*# reg_drive_current = 16
#*# tap_drive_current = 16
#*# calibration_16 = gASVygMAAAAAAAB9lCiMAXaUSwWMBGZ0b2iUjBtudW1weS5wb2x5bm9taWFsLnBvbHlub21pYWyUjApQb2x5bm9taWFslJOUKYGUfZQojARjb2VmlIwVbnVtcHkuY29yZS5tdWx0aWFycmF5lIwMX3JlY29uc3RydWN0lJOUjAVudW1weZSMB25kYXJyYXmUk5RLAIWUQwFilIeUUpQoSwFLCoWUaAyMBWR0eXBllJOUjAJmOJSJiIeUUpQoSwOMATyUTk5OSv////9K/////0sAdJRiiUNQ/+WM3A8Q9D81krpViGj7P5Cix3VUK+g/6IJGK9602z+cu/AUl9LSPzuZw8erGtA/l9PWtFt3mz/qsaD0X8u2v2WvgPQnWsU/NEr4j6o9xz+UdJRijAZkb21haW6UaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxBOmh/zR2mUPg9YMdx1/ZQ+lHSUYowGd2luZG93lGgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQAAAAAAAA8L8AAAAAAADwP5R0lGKMB19zeW1ib2yUjAF4lIwGc3ltYm9slGgsdWKMCWZ0b2hfaGlnaJRoBSmBlH2UKGgIaAtoDksAhZRoEIeUUpQoSwFLCoWUaBiJQ1AxNvbMbUQaQFNq+gY0aQhAUrbO7qgg+T/eCaF61RH4P6GF4WRyZPQ/jxAL7d8b7b+XbrZp6b3qvxmB2OxnkP8/LxNySd7D9D8IqvDdt17Qv5R0lGJoHWgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQVGXkfUn5lD41/JQ8vhOVPpR0lGJoJGgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQAAAAAAAA8L8AAAAAAADwP5R0lGJoK2gsaC1oLHVijARodG9mlGgFKYGUfZQoaAhoC2gOSwCFlGgQh5RSlChLAUsKhZRoGIlDUHtoB20v25Q+06Coi1LELD5CRifGZrwhvlGhNddDiBI+9S4UiTtz6L1xFYYAMD0Cvj4HJ0Z/r/m9UZLhIa+AET5CgWLEbF/zPRVi2RBiMQS+lHSUYmgdaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxAAy1Ma1ag9P7ZhRzFE+BNAlHSUYmgkaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxAAAAAAAADwvwAAAAAAAPA/lHSUYmgraCxoLWgsdWKMB2hfcmFuZ2WUXZQoRz89qNUaU8sAR0At/+aDsKP9ZYwHZl9yYW5nZZRdlChHQUhKr5vg+ABHQUkVjjGh6ABljAJkY5RLEHUu
